<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="static/css/style.css">
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"></script>
    <style id="code-style">
</style>
    <title>Hello!</title>
  </head>
  <body>
    <div class="container">
      <div class="top">
        <h1 class="title">yo yo</h1>
        <p>bonjour</p>
      </div>
      <div class="code">
        <div class="field">
          <label for="code" class="label">Code</label>
          <div class="control">
            <textarea id="code" name="code" class="textarea has-fixed-size" placeholder="Textarea"></textarea>
          </div>
        </div>
      </div>
      <div class="options">
        <div class="field">
          <label for="language" class="label">Language:</label>
          <div class="control">
            <div class="select">
              <select id="language" name='language'>
                <option value='python' selected='selected'>python</option>
                <option value='javascript'>javascript</option>
                <option value='ruby'>ruby</option>
              </select>
            </div>
          </div>
        </div>
        <div class="field">
          <label for="style" class="label">Style:</label>
          <div class="control">
            <div class="select">
              <select id="style" name='style'>
                <option value='default' selected='selected'>default</option>
                <option value='colorful'>colorful</option>
                <option value='emacs'>emacs</option>
                <option value='friendly'>friendly</option>
                <option value='vim'>vim</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="results">
          <label for="results" class="label">Results:</label>
          <div class="result_space">
            <pre></pre>
          </div>
      </div>
      <div class="output">
          <label for="output" class="label">HTML:</label>
          <textarea id="output" name="output" class="textarea has-fixed-size"></textarea>
      </div>
      <div class="styles">
          <label for="styles" class="label">CSS:</label>
          <textarea id="styles" name="styles" class="textarea has-fixed-size"></textarea>
      </div>
    </div>
  <script type="text/javascript">
    // https://stackoverflow.com/a/18484799/8284351
    var delay = (function() {
        var timer = 0;
        return function(callback, ms) {
            clearTimeout(timer);
            timer = setTimeout(callback, ms);
        };
    })();

    var baseline_style = ".highlight pre { font-family: monospace; font-size: 1em; overflow-x: auto; padding: 1.25rem 1.5rem; white-space: pre; word-wrap: normal; } \n"

    var render = (function() {
        var body = {
            code: $('.textarea').val(),
            language: $('#language').val(),
            style: $('#style').val(),
        };

        var poster = $.ajax({
            type: "POST",
            url: "/render",
            dataType: 'json',
            contentType: 'application/json',
            data: JSON.stringify(body),
            processData: false,
            success: function(data) {
              $('.result_space').empty().append(data.results);
              $('#output').val(data.results);
              $('#styles').val(baseline_style + data.styles);
              $('#code-style').html(data.styles);
            }
        });
    });

    $('.textarea').keyup(function() {
        delay(render, 1000);
    });

    $('select').change(render);

    // https://stackoverflow.com/questions/6140632/how-to-handle-tab-in-textarea
    $(document).delegate('textarea', 'keydown', function(e) {
      var keyCode = e.keyCode || e.which;

      if (keyCode == 9) {
        e.preventDefault();
        var start = this.selectionStart;
        var end = this.selectionEnd;

        // set textarea value to: text before caret + tab + text after caret
        $(this).val($(this).val().substring(0, start)
                    + "    "
                    + $(this).val().substring(end));

        // put caret at right position again
        this.selectionStart =
        this.selectionEnd = start + 4;
      }
    }); 
  </script>
  </body>
</html>
